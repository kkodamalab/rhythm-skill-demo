<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Rhythm Step & Clap</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:sans-serif;
  text-align:center;
}

/* ===== ç¸¦é•·ã‚«ãƒ¡ãƒ©è¡¨ç¤º ===== */
#cameraArea{
  position:relative;
  width:100%;
  height:65vh;          /* ç¸¦é•·ã‚’å¼·èª¿ */
  overflow:hidden;
  background:#000;
}
video{
  width:100%;
  height:100%;
  object-fit:cover;
  transform: scaleX(-1); /* é¡åƒ */
}

/* ===== UI ===== */
h2{
  margin:10px 0 6px;
  font-size:22px;
}
.controls{
  margin:6px 0;
}
select, button{
  font-size:16px;
  padding:4px 10px;
  margin:2px;
}
#status{
  margin-top:8px;
  font-size:18px;
}
#result{
  margin-top:6px;
  font-size:18px;
  font-weight:bold;
}
.note{
  opacity:0.8;
  font-size:14px;
}
</style>
</head>

<body>

<h2>ğŸµ Rhythm Step & Clap</h2>

<div class="controls">
  æ‹å­ï¼š
  <select id="meter">
    <option value="4">4æ‹å­</option>
    <option value="8">8æ‹å­</option>
  </select>
 ã€€
  ãƒ†ãƒ³ãƒï¼š
  <select id="bpm">
    <option value="60">60</option>
    <option value="80" selected>80</option>
    <option value="100">100</option>
  </select>
</div>

<div class="controls">
  ã‚¯ãƒ©ãƒƒãƒ—ã™ã‚‹æ‹ï¼š
  <select id="clapRule">
    <option value="1">1æ‹ç›®</option>
    <option value="2">2æ‹ç›®</option>
    <option value="13">1ï¼‹3æ‹</option>
  </select>
</div>

<!-- ã‚«ãƒ¡ãƒ© -->
<div id="cameraArea">
  <video id="video" playsinline></video>
</div>

<button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>

<div id="status">å¾…æ©Ÿä¸­</div>
<div id="result"></div>
<div class="note">
  è¶³è¸ã¿ã§ã‚«ã‚¦ãƒ³ãƒˆ<br>
  æŒ‡å®šã®æ‹ã§ã€Œãƒ‘ãƒ³ï¼ã€ã¨ã‚¯ãƒ©ãƒƒãƒ—
</div>

<script>
/* =====================
   çŠ¶æ…‹
===================== */
let audioCtx;
let beat = 0;
let beatCountTotal = 0;
let lastBeatTime = 0;
let clapCooldown = false;
let metroTimer = null;

const MAX_BEATS = 16;          // â˜… 16æ‹ã§çµ‚äº†
const clapErrors = [];        // ã‚¿ã‚¤ãƒŸãƒ³ã‚°èª¤å·®ï¼ˆmsï¼‰

const status = document.getElementById("status");
const result = document.getElementById("result");

/* =====================
   ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ 
===================== */
function playTone(freq){
  const o = audioCtx.createOscillator();
  o.frequency.value = freq;
  o.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + 0.05);
}

function startMetronome(bpm, meter){
  const interval = 60000 / bpm;
  if(metroTimer) clearInterval(metroTimer);

  metroTimer = setInterval(()=>{
    beat = (beat % meter) + 1;
    beatCountTotal++;
    lastBeatTime = performance.now();

    playTone(beat === 1 ? 900 : 500);

    // â˜… 16æ‹ã§è‡ªå‹•ã‚¹ãƒˆãƒƒãƒ—
    if(beatCountTotal >= MAX_BEATS){
      stopTask();
    }
  }, interval);
}

/* =====================
   ã‚¯ãƒ©ãƒƒãƒ—æ¤œå‡ºï¼ˆéŸ³å£°ï¼‰
===================== */
async function initMic(){
  const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
  const mic = audioCtx.createMediaStreamSource(stream);
  const analyser = audioCtx.createAnalyser();
  mic.connect(analyser);

  const data = new Uint8Array(analyser.fftSize);

  function detectClap(){
    analyser.getByteTimeDomainData(data);
    const vol = data.reduce((a,b)=>a+Math.abs(b-128),0);

    if(vol > 2000 && !clapCooldown && metroTimer){
      clapCooldown = true;
      const rule = document.getElementById("clapRule").value;
      const ok = rule.includes(beat.toString());
      const err = Math.round(performance.now() - lastBeatTime);

      if(ok){
        clapErrors.push(Math.abs(err));
        status.textContent = `ğŸ‘ OK (${err} ms)`;
      }else{
        status.textContent = `ğŸ˜… ã¡ãŒã†æ‹ (${err} ms)`;
      }
      setTimeout(()=>clapCooldown=false,300);
    }
    requestAnimationFrame(detectClap);
  }
  detectClap();
}

/* =====================
   ã‚«ãƒ¡ãƒ©ï¼ˆç¸¦é•·ãƒ»é¡åƒï¼‰
===================== */
async function startCamera(){
  const video = document.getElementById("video");
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "user" },
    audio: false
  });
  video.srcObject = stream;
  video.play();
}

/* =====================
   ã‚¹ãƒˆãƒƒãƒ—ï¼†æˆç¸¾è¡¨ç¤º
===================== */
function stopTask(){
  clearInterval(metroTimer);
  metroTimer = null;

  const avgErr = clapErrors.length
    ? Math.round(clapErrors.reduce((a,b)=>a+b,0) / clapErrors.length)
    : "â€”";

  status.textContent = "çµ‚äº†";
  result.textContent =
    `å¹³å‡ã‚¿ã‚¤ãƒŸãƒ³ã‚°èª¤å·®ï¼š${avgErr} msï¼ˆ${clapErrors.length} å›ï¼‰`;
}

/* =====================
   ã‚¹ã‚¿ãƒ¼ãƒˆ
===================== */
document.getElementById("startBtn").onclick = async ()=>{
  // åˆæœŸåŒ–
  clapErrors.length = 0;
  beat = 0;
  beatCountTotal = 0;
  result.textContent = "";

  audioCtx = new AudioContext();
  await startCamera();
  await initMic();

  const bpm = Number(document.getElementById("bpm").value);
  const meter = Number(document.getElementById("meter").value);
  startMetronome(bpm, meter);

  status.textContent = "è¨ˆæ¸¬ä¸­ï¼ˆ16æ‹ï¼‰";
};
</script>

</body>
</html>
